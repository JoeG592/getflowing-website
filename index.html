<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Flowing, eh - AI-Powered Power Automate Flow Generation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Clerk -->
  <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_dm9jYWwtc3VuYmVhbS0yOC5jbGVyay5hY2NvdW50cy5kZXYk" src="https://vocal-sunbeam-28.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [prompt, setPrompt] = useState('');
      const [flowName, setFlowName] = useState('');
      const [dataverseUrl, setDataverseUrl] = useState('');
      const [generatedFlow, setGeneratedFlow] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [progressLog, setProgressLog] = useState([]);
      const [user, setUser] = useState(null);
      const [usage, setUsage] = useState(null);

      useEffect(() => {
        initClerk();
      }, []);

      const initClerk = async () => {
        await Clerk.load();
        setUser(Clerk.user);
        
        if (Clerk.user) {
          // TODO: Fetch real usage from backend
          setUsage({ tier: 'free', used: 0, limit: 3, remaining: 3 });
        }
      };

      const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setProgressLog(prev => [...prev, { timestamp, message, type }]);
      };

      const handleGenerate = async () => {
        // Check if user is signed in
        if (!user) {
          if (confirm('You need to sign in to generate flows. Sign in now?')) {
            window.location.href = '/pages/signin.html';
          }
          return;
        }

        // Check usage limits
        if (usage && usage.remaining <= 0) {
          if (confirm(`You've used all ${usage.limit} flows this month. Upgrade to Pro for 50 flows/month?`)) {
            window.location.href = '/pages/pricing.html';
          }
          return;
        }

        if (!prompt.trim()) {
          alert('Please describe what you want to automate!');
          return;
        }

        setIsGenerating(true);
        setGeneratedFlow(null);
        setProgressLog([]);

        addLog('Calling backend API to generate your flow...', 'info');

        try {
          const response = await fetch('/api/generate-flow', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt,
              flowName: flowName || 'My Automation',
              userId: user.id
            })
          });

          const data = await response.json();
          
          if (data.upgradeRequired) {
            addLog('Usage limit reached!', 'error');
            if (confirm(`You've reached your ${data.tier} tier limit. Upgrade to continue?`)) {
              window.location.href = '/pages/pricing.html';
            }
            return;
          }

          if (data.success) {
            addLog('Flow generated successfully!', 'success');
            addLog('Packaging your flow...', 'info');
            setGeneratedFlow(data.rawJson);
            
            // Update usage
            if (data.usage) {
              setUsage(data.usage);
            }
            
            setTimeout(() => {
              addLog('Solution package ready!', 'success');
              addLog('Preparing deployment...', 'info');
            }, 500);
          } else {
            throw new Error(data.error || 'Failed to generate flow');
          }
        } catch (error) {
          console.error('Error:', error);
          addLog(`Error: ${error.message}`, 'error');
          alert('Failed to generate flow. Please try again!');
        } finally {
          setIsGenerating(false);
        }
      };

      const handleDownload = () => {
        if (!generatedFlow) return;
        
        const blob = new Blob([generatedFlow], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${flowName || 'my-automation'}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleSignOut = async () => {
        await Clerk.signOut();
        setUser(null);
        setUsage(null);
      };

      return (
        <div className="min-h-screen bg-red-50">
          {/* Header Navigation */}
          <div className="bg-white border-b border-gray-900">
            <div className="max-w-7xl mx-auto px-8 py-6 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-slate-600 rounded-lg flex items-center justify-center">
                  <span className="text-white text-2xl font-bold">GF</span>
                </div>
                <span className="text-2xl font-bold text-red-600">GET FLOWING, EH</span>
              </div>
              <nav className="flex gap-6 items-center">
                <a href="/" className="text-red-600 font-bold">Home</a>
                <a href="/pages/pricing.html" className="text-gray-700 hover:text-red-600 font-medium">Pricing</a>
                {user ? (
                  <>
                    <a href="/pages/dashboard.html" className="text-gray-700 hover:text-red-600 font-medium">Dashboard</a>
                    <button onClick={handleSignOut} className="text-gray-700 hover:text-red-600 font-medium">Sign Out</button>
                  </>
                ) : (
                  <>
                    <a href="/pages/signin.html" className="text-gray-700 hover:text-red-600 font-medium">Sign In</a>
                    <a href="/pages/signup.html" className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700">Sign Up Free</a>
                  </>
                )}
              </nav>
            </div>
          </div>

          {/* Main Content */}
          <div className="max-w-5xl mx-auto px-8 py-12">
            {/* Hero Section */}
            <div className="bg-white rounded-2xl border-2 border-gray-900 p-12 mb-8 shadow-lg">
              <div className="flex items-center justify-center gap-4 mb-6">
                <div className="w-16 h-16 bg-slate-600 rounded-xl flex items-center justify-center">
                  <span className="text-white text-3xl font-bold">GF</span>
                </div>
                <h1 className="text-5xl font-bold text-red-600">GET FLOWING, EH</h1>
              </div>
              <p className="text-2xl text-center text-gray-700 mb-2">
                TURN YOUR IDEAS INTO WORKING AUTOMATION‚ÄîINSTANTLY.
              </p>
              <p className="text-center text-gray-600">
                No coding required. No technical knowledge needed. Just tell us what you want automated.
              </p>
            </div>

            {/* Usage Banner (if logged in) */}
            {user && usage && (
              <div className="bg-white rounded-xl border-2 border-gray-900 p-4 mb-4 flex items-center justify-between shadow">
                <div className="flex items-center gap-4">
                  <span className="text-2xl">üë§</span>
                  <div>
                    <p className="font-bold text-gray-900">Welcome back, {user.firstName}!</p>
                    <p className="text-sm text-gray-600">
                      {usage.remaining} of {usage.limit} flows remaining this month ({usage.tier} tier)
                    </p>
                  </div>
                </div>
                {usage.remaining < 2 && usage.tier === 'free' && (
                  <a href="/pages/pricing.html" className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 text-sm">
                    Upgrade to Pro
                  </a>
                )}
              </div>
            )}

            {/* Form Section */}
            <div className="bg-white rounded-2xl border-2 border-gray-900 p-8 mb-8 shadow-lg">
              <h2 className="text-2xl font-bold mb-6 text-gray-900">Describe what you want to automate</h2>
              
              <textarea
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
                className="w-full p-4 border-2 border-gray-900 rounded-xl mb-4 font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-red-600"
                rows="6"
                placeholder="Example: When someone fills out my contact form, send me an email and add their info to my spreadsheet"
              />

              <div className="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold mb-2 text-gray-900">
                    Flow Name (optional)
                  </label>
                  <input
                    type="text"
                    value={flowName}
                    onChange={(e) => setFlowName(e.target.value)}
                    className="w-full p-3 border-2 border-gray-900 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-600"
                    placeholder="My Automation"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2 text-gray-900">
                    Dataverse URL
                  </label>
                  <input
                    type="text"
                    value={dataverseUrl}
                    onChange={(e) => setDataverseUrl(e.target.value)}
                    className="w-full p-3 border-2 border-gray-900 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-600"
                    placeholder="https://yourorg.crm.dynamics.com"
                  />
                </div>
              </div>

              <button
                onClick={handleGenerate}
                disabled={isGenerating}
                className={`w-full py-4 px-6 rounded-xl font-bold text-xl transition-all shadow-lg ${
                  isGenerating
                    ? 'bg-gray-400 cursor-not-allowed'
                    : 'bg-red-600 text-white hover:bg-red-700 hover:shadow-xl'
                }`}
              >
                {isGenerating ? 'üîÑ GENERATING...' : user ? 'üöÄ GENERATE MY FLOW' : 'üîí SIGN IN TO GENERATE'}
              </button>

              {!user && (
                <p className="text-center mt-4 text-gray-600 text-sm">
                  <a href="/pages/signup.html" className="text-red-600 font-bold hover:underline">Sign up free</a> to start generating flows!
                </p>
              )}
            </div>

            {/* Results Section */}
            {(generatedFlow || progressLog.length > 0) && (
              <div className="grid grid-cols-2 gap-8 mb-8">
                {/* Generated Flow */}
                <div className="bg-white rounded-2xl border-2 border-gray-900 p-6 shadow-lg">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">‚úÖ</span>
                    <h3 className="text-xl font-bold text-gray-900">Generated Flow</h3>
                  </div>
                  <pre className="bg-gray-50 p-4 rounded-xl border border-gray-900 overflow-auto max-h-96 text-xs font-mono">
                    {generatedFlow || 'Generating...'}
                  </pre>
                </div>

                {/* Ready to Deploy */}
                <div className="bg-white rounded-2xl border-2 border-gray-900 p-6 shadow-lg">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">üöÄ</span>
                    <h3 className="text-xl font-bold text-gray-900">Ready to Deploy</h3>
                  </div>
                  
                  <div className="bg-gray-50 p-4 rounded-xl border border-gray-900 mb-4">
                    <p className="font-semibold mb-1 text-gray-900">Status</p>
                    <p className="text-lg text-gray-700">DEMO</p>
                  </div>

                  <div className="bg-gray-50 p-4 rounded-xl border border-gray-900 mb-4">
                    <p className="font-semibold mb-2 text-gray-900">Next Steps</p>
                    <p className="text-sm text-gray-700">
                      Flow generated successfully! Download the JSON below and run the deployment script.
                    </p>
                  </div>

                  {generatedFlow && (
                    <button
                      onClick={handleDownload}
                      className="w-full bg-red-600 text-white py-3 px-6 rounded-xl font-bold hover:bg-red-700 transition-all shadow-lg"
                    >
                      üì• DOWNLOAD FLOW JSON
                    </button>
                  )}
                </div>
              </div>
            )}

            {/* Progress Log */}
            {progressLog.length > 0 && (
              <div className="bg-white rounded-2xl border-2 border-gray-900 p-6 shadow-lg">
                <h3 className="text-xl font-bold mb-4 text-gray-900">Progress Log</h3>
                <div className="space-y-2 max-h-64 overflow-auto">
                  {progressLog.map((log, idx) => (
                    <div
                      key={idx}
                      className={`p-3 rounded-lg border ${
                        log.type === 'success'
                          ? 'bg-green-50 border-green-600 text-green-800'
                          : log.type === 'error'
                          ? 'bg-red-50 border-red-600 text-red-800'
                          : 'bg-blue-50 border-blue-600 text-blue-800'
                      }`}
                    >
                      <span className="text-xs font-mono opacity-75">{log.timestamp} p.m.</span>
                      <span className="ml-2">
                        {log.type === 'success' && '‚úÖ'}
                        {log.type === 'error' && '‚ùå'}
                        {log.type === 'info' && 'üîÑ'}
                      </span>
                      <span className="ml-2">{log.message}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Footer */}
          <div className="mt-20 border-t border-gray-900 bg-white">
            <div className="max-w-7xl mx-auto px-8 py-8 text-center">
              <p className="text-gray-600 text-sm mb-1">
                Proudly made in Edmonton, Alberta, Canada üá®üá¶
              </p>
              <p className="text-gray-500 text-xs">
                Powered by Claude AI ‚Ä¢ Built for Power Automate
              </p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
